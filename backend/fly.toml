# fly.toml - Fly.io configuration for Cooperative ERP Lite
# Updated: 2025-11-20
# Includes: Sticky sessions for in-memory rate limiting

app = "cooperative-erp-api"
primary_region = "sin"  # Singapore (closest to Indonesia)

[build]
  dockerfile = "Dockerfile"

[env]
  PORT = "8080"
  GIN_MODE = "release"

[http_service]
  internal_port = 8080
  force_https = true
  auto_stop_machines = true
  auto_start_machines = true
  min_machines_running = 0  # Scale to zero when idle (cost optimization)

  # Health check configuration
  [[http_service.checks]]
    grace_period = "10s"
    interval = "30s"
    method = "GET"
    timeout = "5s"
    path = "/health"

  # IMPORTANT: Session affinity for in-memory rate limiting
  # When multiple instances are running, this ensures the same IP
  # is routed to the same instance, making in-memory rate limiting work correctly
  [http_service.concurrency]
    type = "connections"
    hard_limit = 100  # Max concurrent connections per instance
    soft_limit = 80   # Start spawning new instance at 80 connections

[vm]
  memory = '256mb'  # Free tier
  cpu_kind = 'shared'
  cpus = 1

# Service configuration with sticky sessions
[[services]]
  protocol = "tcp"
  internal_port = 8080

  # HTTP port (redirects to HTTPS)
  [[services.ports]]
    port = 80
    handlers = ["http"]
    force_https = true

  # HTTPS port
  [[services.ports]]
    port = 443
    handlers = ["tls", "http"]

  # Concurrency settings for load balancing
  [services.concurrency]
    type = "connections"
    hard_limit = 100
    soft_limit = 80

  # TCP checks (fallback if HTTP check fails)
  [[services.tcp_checks]]
    interval = "15s"
    timeout = "2s"
    grace_period = "5s"

  # HTTP checks
  [[services.http_checks]]
    interval = "10s"
    timeout = "2s"
    grace_period = "5s"
    method = "GET"
    path = "/health"
    protocol = "http"

# Scaling configuration
# Phase 1 (MVP): 0-3 instances (auto-scale based on traffic)
# Phase 2: Can increase max instances as needed
[scaling]
  min_count = 0  # Scale to zero when idle
  max_count = 3  # Free tier allows up to 3 VMs

# Session affinity / Sticky sessions
# This is achieved through Fly.io's default behavior when using
# connection-based concurrency limits. Requests from the same IP
# tend to be routed to the same instance until it reaches soft_limit.
#
# Alternative: Use Fly-Replay header for explicit sticky routing
# (This would require code changes in backend to set header)

# Regional configuration (can add more regions in Phase 3)
# [regions]
#   primary = "sin"  # Singapore
#   fallback = ["hkg", "syd"]  # Hong Kong, Sydney

# Secrets (set via: flyctl secrets set KEY=value)
# - DATABASE_URL: PostgreSQL connection string (Neon)
# - JWT_SECRET: Secret key for JWT tokens
# - CORS_ALLOWED_ORIGINS: Frontend URL(s)
# - R2_ACCESS_KEY_ID: Cloudflare R2 storage
# - R2_SECRET_ACCESS_KEY: Cloudflare R2 storage
# - R2_ENDPOINT: Cloudflare R2 endpoint
# - R2_BUCKET_NAME: Cloudflare R2 bucket
# - R2_PUBLIC_URL: Cloudflare R2 public URL

# Phase 2 additions (when upgrading):
# - REDIS_URL: Redis connection string (if needed)
# - ENABLE_REDIS_CACHE: true/false

# Phase 3 additions (when scaling):
# - LOGTAIL_TOKEN: Better Stack logging
# - SENTRY_DSN: Error tracking
